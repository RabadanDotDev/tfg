\section{Formatos y protocolos de red}

En esta sección definiremos los diferentes protocolos y formatos de red que serán tenidos en cuenta. Concretamente, veremos el formato 'libpcap' en el que las trazas de red son guardadas, las capas de enlace de Ethernet y Linux Cooked Capture v1 (SLL), las capas de red IPv4 e IPv6 y las capas de transporte UDP y TCP.

\subsection{libpcap}

\subsubsection{Descripción}

El formato libpcap es un formato de captura de trazas de red utilizado en TcpDump, WinDump, Wireshark, entre otros \cite{pcapfileformatwireshark} \cite{pcapfileformatrfc}. La estructura general consiste en una cabecera de fichero y a continuación uno cero o más 'Packet Records' o registros de paquetes. Cada uno de estos contiene una cabecera con información de la captura y bytes provenientes del paquete capturado. Adicionalmente, el orden de los campos de los bits dentro de las cabeceras depende del formato nativo de la máquina donde se capturaron los paquetes. 

\subsubsection{Cabecera de fichero}

\begin{figure}[H]
    \begin{center}
        \begin{bytefield}{32}
            \bitheader{0-31} \\
            \bitbox{32}{Número mágico} \\
            \bitbox{16}{Versión mayor} 
            \bitbox{16}{Versión menor} \\
            \bitbox{32}{Reservado 1} \\
            \bitbox{32}{Reservado 2} \\
            \bitbox{32}{Longitud máxima capturada} \\
            \bitbox{3}{FCS} & \bitbox{1}{f}
            \bitbox{28}{Tipo capa de enlace} \\
            \bitheader{0-31} \\
        \end{bytefield}
    \end{center}
    \caption{Formato cabecera archivo libpcap}
    \label{fig:libpcap_file_header}
\end{figure}

El orden de los campos en la cabecera del fichero es como podemos ver en la Figura \ref{fig:libpcap_file_header}. El significado de los campos es el siguiente:

\begin{enumerate}
    \item \textbf{Número mágico}: Permite identificar el archivo como pcap, conocer la precisión de los campos de tiempo y saber el orden de bits de las cabeceras. El valor del campo en hexadecimal es \texttt{0xA1B2C3D4} si tenemos segundos y microsegundos. En caso de que sea \texttt{0xA1B23C4D}, tenemos precisión de nanosegundos en vez de microsegundos. Finalmente, si el primer byte del fichero tiene el valor \texttt{0xA1}, los campos tienen el orden 'big endian' (los bytes más significativos aparecen primero). En el caso opuesto, tienen el orden 'little endian' (los bytes menos significativos aparecen primero).
    \item \textbf{Versión mayor}: Valor no entero representando la versión semántica mayor \cite{preston2013semantic}. La última versión hasta la fecha es 2.
    \item \textbf{Versión menor}: Valor no entero, representando la versión semántica menor \cite{preston2013semantic}. La última versión hasta la fecha es la 4.
    \item \textbf{Reservado 1}: Valor no utilizado en la actualidad. En versiones antiguas se utilizaba para marcar la diferencia de huso horario.
    \item \textbf{Reservado 2}: Valor no utilizado en la actualidad. En versiones antiguas se utilizaba para indicar la precisión de las marcas de tiempo.
    \item \textbf{Longitud máxima capturada}: Número máximo de bytes de los paquetes originales que pueden ser incluidos en la traza de red. Si hay algún paquete que originalmente es más grande que este tamaño, se trunca a la longitud indicada.
    \item \textbf{FCS/f}: si el bit "f" está a 1, los siguientes 3 bits indican el número de bytes de detección de errores añadidos a continuación. 
    \item \textbf{Tipo capa de enlace}: Número identificando el tipo de la capa de enlace utilizado. Algunos ejemplos son 1 para IEEE 802.3 (Ethernet) o 113 para 'Linux Cooked Capture v1' \cite{linktypetcpdump}
\end{enumerate}

\subsubsection{Registro de paquete}

El orden de los campos en la cabecera del fichero es como podemos ver en la Figura \ref{fig:libpcap_file_packet_record}. La marca se encuentra representada como el número de segundos y micro/nanosegundos (dependiendo de la cabecera del fichero) transcurridos desde el 1 de enero de 1970 a las 00:00 UTC. Se incluye el tamaño del paquete original y el capturado, ya que no todos los paquetes de la captura tienen necesariamente el mismo tamaño que el original ni entre ellos.

\begin{figure}[h]
    \begin{center}
        \begin{bytefield}{32}
            \bitheader{0-31} \\
            \bitbox{32}{Marca de tiempo (parte de segundos)} \\
            \bitbox{32}{Marca de tiempo (parte de micro/nanosegundos)} \\ 
            \bitbox{32}{Tamaño del paquete capturado} \\
            \bitbox{32}{Tamaño del paquete original} \\
            \wordbox{3}{Datos del paquete} \\
        \end{bytefield}
    \end{center}
    \caption{Formato registro de paquete archivo libpcap}
    \label{fig:libpcap_file_packet_record}
\end{figure}

\subsection{Ethernet}

por hacer

\subsection{Linux Cooked Capture v1 (SLL)}

por hacer

\subsection{IP versión 4}

por hacer

\subsection{IP versión 6}

por hacer

\subsection{UDP}

por hacer

\subsection{TCP}

por hacer
